name: Build iOS IPA (App Store)
on:
  push:
    branches: [ main ] # 推送到main分支时触发打包
  workflow_dispatch: # 支持手动触发

jobs:
  build-ipa:
    runs-on: macos-latest # GitHub 提供的云端 macOS（自带 Xcode）
    steps:
      - name: 拉取 Git 代码
        uses: actions/checkout@v4

      - name: 配置 Xcode 版本
        run: sudo xcode-select -switch /Applications/Xcode_15.2.app # 适配最新 Xcode

      - name: 导入苹果签名证书
        env:
          P12_FILE: ${{ secrets.P12_FILE }} # GitHub 密钥：base64 编码的 .p12
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }} # GitHub 密钥：证书密码
          PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }} # GitHub 密钥：base64 编码的描述文件
        run: |
          # 解码并保存证书
          echo $P12_FILE | base64 --decode > Cert.p12
          # 解码并保存描述文件
          echo $PROVISIONING_PROFILE | base64 --decode > Profile.mobileprovision
          # 导入证书到钥匙串
          security create-keychain -p github-actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p github-actions build.keychain
          security import Cert.p12 -k build.keychain -P $P12_PASSWORD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k github-actions build.keychain
          # 安装描述文件
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp Profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: 编译并打包 IPA
        run: |
          # 清理项目
          xcodebuild clean -project HabitApp.xcodeproj -scheme HabitApp -configuration Release
          # 归档（生成 .xcarchive）
          xcodebuild archive -project HabitApp.xcodeproj -scheme HabitApp -configuration Release -archivePath ./HabitApp.xcarchive
          # 导出 IPA（使用你的 exportOptions.plist）
          xcodebuild -exportArchive -archivePath ./HabitApp.xcarchive -exportPath ./IPA -exportOptionsPlist ./exportOptions.plist

      - name: 上传 IPA 作为构建产物
        uses: actions/upload-artifact@v4
        with:
          name: HabitApp-IPA
          path: ./IPA/HabitApp.ipa # 导出的 IPA 路径（和你的项目名称一致）