name: Build iOS IPA

on:
  push:
    branches: [ master ]
  workflow_dispatch: # 支持手动触发

jobs:
  build-ipa:
    runs-on: macos-latest
    steps:
      - name: 拉取Git代码
        uses: actions/checkout@v4

      - name: 导入苹果签名证书
        env:
          P12_FILE: ${{ secrets.P12_FILE }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
        run: |
          # 创建证书目录
          mkdir -p ~/Library/MobileDevice/Certificates
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # 解码并保存P12证书
          echo "$P12_FILE" | base64 --decode > ~/Library/MobileDevice/Certificates/HabitApp.p12
          # 解码并保存描述文件
          echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/HabitApp.mobileprovision

      - name: 配置Xcode签名
        run: |
          # 查看可用的Xcode版本
          xcode-select -p
          # 设置签名模式为手动
          xcodebuild -project HabitApp.xcodeproj -scheme HabitApp -configuration Release \
          CODE_SIGN_IDENTITY="iPhone Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="HabitApp"

      - name: 清理并归档（核心步骤，修复archive not found）
        run: |
          xcodebuild clean -project HabitApp.xcodeproj -scheme HabitApp -configuration Release
          # 强制归档，指定签名和输出路径
          xcodebuild archive -project HabitApp.xcodeproj -scheme HabitApp -configuration Release \
          -archivePath ./HabitApp.xcarchive \
          CODE_SIGN_IDENTITY="iPhone Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="HabitApp" \
          DEVELOPMENT_TEAM="你的苹果开发者团队ID" # 替换为你的团队ID（可在App Store Connect查看）

      - name: 导出IPA
        run: |
          # 创建导出目录
          mkdir -p ./IPA
          # 导出IPA，自动匹配签名
          xcodebuild -exportArchive -archivePath ./HabitApp.xcarchive \
          -exportPath ./IPA \
          -exportOptionsPlist <(cat << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string> <!-- 测试用改为ad-hoc -->
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>teamID</key>
              <string>你的苹果开发者团队ID</string> <!-- 替换为真实团队ID -->
          </dict>
          </plist>
          EOF
          )

      - name: 上传IPA作为产物
        uses: actions/upload-artifact@v4
        with:
          name: HabitApp-IPA
          path: ./IPA/*.ipa